---
 - hosts: localhost
   become: true
   vars_files:
      - users.yml
   tasks:
     - name: Add Users
       user:
         name: "{{ item.name }}"
         create_home: yes
         password: "{{ 'password' | password_hash('sha512') }}"
         update_password: on_create
       with_items: "{{ users }}"

     - name : create .ssh folder
       file:
         path: "/home/{{ item.name }}/.ssh"
         owner: "{{ item.name }}"
         state: directory
       with_items: "{{ users }}"

     - name : create authorized key folder
       file:
         path: "/home/{{ item.name }}/.ssh/authorized_keys"
         owner: "{{ item.name }}"
         state: touch
       with_items: "{{ users }}"

     - name: copy the authorized keys
       copy:
         src: "{{ item.name }}_id_rsa.pub"
         dest: "/home/{{ item.name}}/.ssh/authorized_keys"
         owner: "{{ item.name }}"
       with_items: "{{ users }}"
